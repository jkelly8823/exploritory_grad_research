 

VULNERABLE: YES
VULNERABLE_LINES: 5
VULNERABILITY_DESCRIPTION: The code is vulnerable to a potential buffer overflow due to the use of EVP_CTRL_AEAD_GET_TAG, which can return a value larger than the size of the out buffer.
EXPLANATION: The EVP_CTRL_AEAD_GET_TAG function can return a value larger than the size of the out buffer, which can lead to a buffer overflow if the returned value is not properly checked. This can be exploited by an attacker to potentially execute arbitrary code.
RECOMMENDATIONS: To fix this vulnerability, the code should check the return value of EVP_CTRL_AEAD_GET_TAG to ensure it does not exceed the size of the out buffer. This can be done by adding a check before incrementing the outlen variable. For example: if (EVP_CIPHER_CTX_ctrl(ctx, EVP_CTRL_AEAD_GET_TAG, (int)mac_len, out+outlen) < 0) { ERR_raise(ERR_LIB_PKCS12, ERR_R_INTERNAL_ERROR); goto err; } else if (outlen + mac_len > out_size) { ERR_raise(ERR_LIB_PKCS12, ERR_R_INTERNAL_ERROR); goto err; } outlen += mac_len